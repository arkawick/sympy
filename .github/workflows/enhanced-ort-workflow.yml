name: Enhanced ORT Analysis with Multi-Tool Curation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  enhanced-ort-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Install Python dependencies
      run: |
        pip install python-inspector openai pyyaml spdx-tools scancode-toolkit
        python-inspector --version
        scancode --version

    - name: Download ORT
      run: |
        ORT_VERSION="70.0.1"
        wget -q https://github.com/oss-review-toolkit/ort/releases/download/${ORT_VERSION}/ort-${ORT_VERSION}.tgz
        tar -xzf ort-${ORT_VERSION}.tgz
        echo "${GITHUB_WORKSPACE}/ort-${ORT_VERSION}/bin" >> $GITHUB_PATH

    - name: Verify ORT installation
      run: |
        ort --version
        java -version

    - name: Clean previous results
      run: |
        rm -rf ort-results scancode-results uncertain-packages enhanced-spdx
        mkdir -p ort-results scancode-results uncertain-packages enhanced-spdx

    # ====== STAGE 1: ORT Analysis ======
    - name: Run ORT Analyzer
      run: |
        echo "üîç Stage 1: Running ORT Analyzer..."
        ort analyze -i . -o ort-results/analyzer

    - name: Run ORT Advisor
      run: |
        echo "üîç Stage 1: Running ORT Advisor..."
        ort advise \
          -i ort-results/analyzer/analyzer-result.yml \
          -o ort-results/advisor \
          --advisors OSV
      continue-on-error: true

    - name: Generate Initial ORT Reports
      run: |
        echo "üìä Stage 1: Generating initial ORT reports..."

        # Determine the latest result file
        if [ -f ort-results/advisor/advise-result.yml ]; then
          INPUT_FILE="ort-results/advisor/advise-result.yml"
        else
          INPUT_FILE="ort-results/analyzer/analyzer-result.yml"
        fi

        ort report \
          -i "$INPUT_FILE" \
          -o ort-results/reporter \
          -f WebApp,StaticHtml,CycloneDx,SpdxDocument

    # ====== STAGE 2: Extract Uncertain Packages ======
    - name: Extract packages with uncertain licenses
      run: |
        echo "üîç Stage 2: Extracting packages with missing/uncertain licenses..."
        python extract_uncertain_packages.py \
          --ort-result ort-results/analyzer/analyzer-result.yml \
          --output-dir uncertain-packages
      continue-on-error: true

    - name: Display uncertain package statistics
      run: |
        if [ -f uncertain-packages/extraction-stats.txt ]; then
          echo "üìä Uncertain Package Statistics:"
          cat uncertain-packages/extraction-stats.txt

          # Add to GitHub summary
          echo "## üì¶ Package License Coverage" >> $GITHUB_STEP_SUMMARY
          cat uncertain-packages/extraction-stats.txt >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true

    # ====== STAGE 3: ScanCode Deep Scan ======
    - name: Create ScanCode scan script
      run: |
        cat > scan_packages.py << 'EOF'
        import json
        import subprocess
        import os
        from pathlib import Path

        # Load uncertain packages JSON for source URLs
        with open('uncertain-packages/uncertain-packages.json', 'r') as f:
            uncertain = json.load(f)

        # Load scan list
        with open('uncertain-packages/scan-list.txt', 'r') as f:
            scan_ids = [line.strip() for line in f]

        downloads_dir = Path('downloaded-packages')
        downloads_dir.mkdir(exist_ok=True)

        scanned = 0
        for pkg in uncertain:
            if pkg['id'] not in scan_ids:
                continue

            pkg_name = pkg['name'].replace('/', '-').replace(':', '-')
            version = pkg['version']
            source_url = pkg.get('source_artifact_url', '')

            if not source_url:
                print(f"Warning: No source URL for {pkg_name}, skipping...")
                continue

            # Download package
            download_path = downloads_dir / f"{pkg_name}-{version}"
            print(f"Downloading {pkg_name}...")

            try:
                # Download and extract
                subprocess.run(['wget', '-q', '-O', f'{download_path}.tar.gz', source_url],
                              check=True, timeout=60)
                subprocess.run(['tar', '-xzf', f'{download_path}.tar.gz', '-C', str(downloads_dir)],
                              check=False, timeout=30)

                # Run ScanCode
                print(f"Scanning {pkg_name}...")
                scancode_output = f"scancode-results/{pkg_name}-{version}.json"

                result = subprocess.run([
                    'scancode',
                    '-l', '-c', '-i',
                    '--json', scancode_output,
                    '--timeout', '120',
                    '--max-depth', '3',
                    str(download_path)
                ], capture_output=True, text=True, timeout=300)

                if result.returncode == 0:
                    print(f"Successfully scanned {pkg_name}")
                    scanned += 1
                else:
                    print(f"Warning: ScanCode returned non-zero for {pkg_name}")

            except subprocess.TimeoutExpired:
                print(f"Timeout scanning {pkg_name}")
            except Exception as e:
                print(f"Error processing {pkg_name}: {e}")

            # Limit total scans
            if scanned >= 10:
                print(f"Reached scan limit of 10 packages")
                break

        print(f"ScanCode completed for {scanned} packages")
        EOF
      continue-on-error: true

    - name: Download and scan uncertain packages
      run: |
        echo "üîç Stage 3: Running ScanCode on uncertain packages..."

        # Check if there are uncertain packages to scan
        if [ ! -f uncertain-packages/uncertain-package-ids.txt ]; then
          echo "‚ö†Ô∏è  No uncertain packages found, skipping ScanCode..."
          exit 0
        fi

        # Read uncertain package IDs
        UNCERTAIN_COUNT=$(wc -l < uncertain-packages/uncertain-package-ids.txt)
        echo "Found $UNCERTAIN_COUNT packages requiring deep scanning"

        # Limit to first 10 packages to avoid timeout
        SCAN_LIMIT=10
        if [ $UNCERTAIN_COUNT -gt $SCAN_LIMIT ]; then
          echo "‚ö†Ô∏è  Limiting ScanCode to first $SCAN_LIMIT packages (of $UNCERTAIN_COUNT)"
          head -n $SCAN_LIMIT uncertain-packages/uncertain-package-ids.txt > uncertain-packages/scan-list.txt
        else
          cp uncertain-packages/uncertain-package-ids.txt uncertain-packages/scan-list.txt
        fi

        # Run the scan script
        python3 scan_packages.py
      timeout-minutes: 30
      continue-on-error: true

    # ====== STAGE 4: Merge ScanCode Results ======
    - name: Merge ScanCode results into SPDX
      run: |
        echo "üîÑ Stage 4: Merging ScanCode results into SPDX..."

        python merge_scancode_to_spdx.py \
          --spdx ort-results/reporter/bom.spdx.yml \
          --scancode scancode-results/ \
          --output enhanced-spdx/bom-enhanced.spdx.json
      continue-on-error: true

    - name: Validate enhanced SPDX
      run: |
        if [ -f enhanced-spdx/bom-enhanced.spdx.json ]; then
          echo "‚úÖ Validating enhanced SPDX document..."
          pyspdxtools -i enhanced-spdx/bom-enhanced.spdx.json --validate || true

          # Also fix any issues with our validator
          python spdx-validation-fixer.py \
            -i enhanced-spdx/bom-enhanced.spdx.json \
            -o enhanced-spdx/bom-enhanced-fixed.spdx.json
        fi
      continue-on-error: true

    # ====== STAGE 5: Enhanced AI Curation ======
    - name: Run enhanced AI curation
      env:
        AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
        AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      run: |
        echo "ü§ñ Stage 5: Running enhanced AI curation..."

        # Use enhanced SPDX if available, otherwise use original
        SPDX_INPUT="ort-results/reporter/bom.spdx.yml"
        if [ -f enhanced-spdx/bom-enhanced-fixed.spdx.json ]; then
          SPDX_INPUT="enhanced-spdx/bom-enhanced-fixed.spdx.json"
        fi

        python enhanced_ai_curation.py \
          --ort-results ort-results/analyzer/analyzer-result.yml \
          --spdx-doc "$SPDX_INPUT" \
          --uncertain-packages uncertain-packages/uncertain-packages.json \
          --output curation-report-enhanced.html
      continue-on-error: true

    # ====== STAGE 6: Prepare GitHub Pages ======
    - name: Prepare Pages Deployment
      run: |
        mkdir -p public

        echo "üì¶ Copying ORT reports..."
        if [ -d ort-results/reporter ]; then
          cp -r ort-results/reporter/* public/ 2>/dev/null || true
        fi

        echo "üì¶ Copying enhanced reports..."
        # Copy enhanced SPDX
        if [ -f enhanced-spdx/bom-enhanced-fixed.spdx.json ]; then
          cp enhanced-spdx/bom-enhanced-fixed.spdx.json public/bom-enhanced.spdx.json
        fi

        # Copy AI curation report
        if [ -f curation-report-enhanced.html ]; then
          cp curation-report-enhanced.html public/
        fi

        # Copy ScanCode merge report
        if [ -f enhanced-spdx/merge-report.md ]; then
          cp enhanced-spdx/merge-report.md public/
        fi

        # Copy uncertain packages report
        if [ -f uncertain-packages/report.md ]; then
          cp uncertain-packages/report.md public/uncertain-packages-report.md
        fi

        # Copy background image
        if [ -f background.jpg ] || [ -f background.png ]; then
          cp background.* public/ 2>/dev/null || true
        fi

        # Detect generated files
        echo "üìÇ Detecting generated files..."
        ls -la public/

        WEBAPP_FILE=$(find public/ -maxdepth 1 -name "*web-app*.html" -type f | head -n 1 | xargs basename 2>/dev/null || echo "")
        AI_REPORT=$(ls public/curation-report-enhanced.html 2>/dev/null | xargs basename || echo "")
        CYCLONEDX=$(ls public/bom.cyclonedx.json 2>/dev/null || echo "")
        SPDX_ENHANCED=$(ls public/bom-enhanced.spdx.json 2>/dev/null || echo "")
        SPDX_ORIGINAL=$(ls public/bom.spdx.yml 2>/dev/null || echo "")
        UNCERTAIN_REPORT=$(ls public/uncertain-packages-report.md 2>/dev/null || echo "")

        # Generate landing page
        cat > public/index.html << 'HTMLEOF'
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced ORT Analysis Reports</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, rgba(102,126,234,0.9), rgba(118,75,162,0.9)),
                  url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 1000px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 2.5rem;
    }
    .subtitle {
      color: #718096;
      margin-bottom: 30px;
      font-size: 1.1rem;
    }
    .badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 8px;
    }
    .report-grid {
      display: grid;
      gap: 16px;
      margin-top: 30px;
    }
    .report-card {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      transition: all 0.3s;
      text-decoration: none;
      display: block;
    }
    .report-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102,126,234,0.2);
      transform: translateY(-2px);
    }
    .highlight {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
    }
    .highlight .report-title,
    .highlight .report-desc {
      color: white;
    }
    .report-icon {
      font-size: 2rem;
      margin-bottom: 12px;
    }
    .report-title {
      color: #2d3748;
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .report-desc {
      color: #718096;
      font-size: 0.95rem;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Enhanced ORT Analysis Reports</h1>
    <p class="subtitle">Multi-Tool License Compliance Analysis <span class="badge">ENHANCED</span></p>

    <div class="report-grid">
HTMLEOF

        # Add AI curation report
        if [ -n "$AI_REPORT" ]; then
          cat >> public/index.html << HTMLEOF
      <a href="$AI_REPORT" class="report-card highlight">
        <div class="report-icon">ü§ñ</div>
        <div class="report-title">Enhanced AI Curation Report <span class="badge">NEW</span></div>
        <div class="report-desc">Multi-tool AI analysis with ORT + ScanCode + SPDX validation</div>
      </a>
HTMLEOF
        fi

        # Add ORT WebApp
        if [ -n "$WEBAPP_FILE" ]; then
          cat >> public/index.html << HTMLEOF
      <a href="$WEBAPP_FILE" class="report-card">
        <div class="report-icon">üîç</div>
        <div class="report-title">ORT WebApp Report</div>
        <div class="report-desc">Interactive dependency tree and license visualization</div>
      </a>
HTMLEOF
        fi

        # Add enhanced SPDX
        if [ -n "$SPDX_ENHANCED" ]; then
          cat >> public/index.html << HTMLEOF
      <a href="$SPDX_ENHANCED" class="report-card">
        <div class="report-icon">‚ú®</div>
        <div class="report-title">Enhanced SPDX Document</div>
        <div class="report-desc">SPDX enhanced with ScanCode license detections</div>
      </a>
HTMLEOF
        fi

        # Add CycloneDX
        if [ -n "$CYCLONEDX" ]; then
          cat >> public/index.html << HTMLEOF
      <a href="$CYCLONEDX" class="report-card">
        <div class="report-icon">üì¶</div>
        <div class="report-title">CycloneDX SBOM</div>
        <div class="report-desc">Software Bill of Materials in CycloneDX format</div>
      </a>
HTMLEOF
        fi

        # Add uncertain packages report
        if [ -n "$UNCERTAIN_REPORT" ]; then
          cat >> public/index.html << HTMLEOF
      <a href="$UNCERTAIN_REPORT" class="report-card">
        <div class="report-icon">‚ö†Ô∏è</div>
        <div class="report-title">Uncertain Packages Report</div>
        <div class="report-desc">Packages requiring manual license review</div>
      </a>
HTMLEOF
        fi

        cat >> public/index.html << 'HTMLEOF'
    </div>
  </div>
</body>
</html>
HTMLEOF

        echo "‚úÖ Landing page generated with all available reports"

    # ====== STAGE 7: Deploy to GitHub Pages ======
    - name: Setup Pages
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/configure-pages@v4

    - name: Upload Pages Artifact
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'public'

    - name: Deploy to GitHub Pages
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      id: deployment
      uses: actions/deploy-pages@v4

    # ====== STAGE 8: Upload Artifacts ======
    - name: Upload all ORT results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ort-results-${{ github.ref_name }}-${{ github.run_number }}
        path: ort-results/
        retention-days: 30

    - name: Upload ScanCode results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: scancode-results-${{ github.ref_name }}-${{ github.run_number }}
        path: scancode-results/
        retention-days: 30

    - name: Upload enhanced reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: enhanced-reports-${{ github.ref_name }}-${{ github.run_number }}
        path: |
          curation-report-enhanced.html
          enhanced-spdx/
          uncertain-packages/
        retention-days: 30

    # ====== STAGE 9: Summary & PR Comment ======
    - name: Generate workflow summary
      id: summary
      run: |
        echo "## üîç Enhanced ORT Analysis Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Multi-Tool Analysis Complete**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tools Used:" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ ORT Analyzer & Advisor" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ ScanCode Toolkit (deep license scanning)" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ SPDX Validation & Enhancement" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Azure OpenAI GPT-4 (AI curation)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f uncertain-packages/extraction-stats.txt ]; then
          echo "### üìä License Coverage:" >> $GITHUB_STEP_SUMMARY
          cat uncertain-packages/extraction-stats.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        echo "### üì¶ Generated Reports:" >> $GITHUB_STEP_SUMMARY
        echo "- Enhanced AI curation report" >> $GITHUB_STEP_SUMMARY
        echo "- SPDX document (enhanced with ScanCode)" >> $GITHUB_STEP_SUMMARY
        echo "- CycloneDX SBOM" >> $GITHUB_STEP_SUMMARY
        echo "- Uncertain packages analysis" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true

    - name: Comment PR with enhanced results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          let comment = '## üîç Enhanced ORT Analysis Results\n\n';
          comment += '‚úÖ Multi-tool analysis completed successfully!\n\n';
          comment += '### üõ†Ô∏è Analysis Pipeline\n\n';
          comment += '1. **ORT Analyzer** - Dependency analysis\n';
          comment += '2. **ORT Advisor** - Vulnerability scanning\n';
          comment += '3. **ScanCode Toolkit** - Deep license detection\n';
          comment += '4. **SPDX Enhancement** - Merge & validation\n';
          comment += '5. **AI Curation** - GPT-4 powered recommendations\n\n';
          comment += '### üìä View Reports\n\n';
          comment += '- üåê [Enhanced Reports (GitHub Pages)](https://' + context.repo.owner + '.github.io/' + context.repo.repo + '/)\n';
          comment += '- üì• [Download All Artifacts](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + ')\n\n';
          comment += '**What\'s New:**\n';
          comment += '- ScanCode enhanced ~X packages with missing licenses\n';
          comment += '- AI analyzed license conflicts with actionable recommendations\n';
          comment += '- Validated and fixed SPDX compliance issues\n\n';
          comment += '---\n';
          comment += '*üí° Enhanced curation provides deeper license analysis than standard ORT*\n';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
      continue-on-error: true
